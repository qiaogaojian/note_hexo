---
title: Python Micromamba + Poetry 环境管理
date: 2024-02-07 10:32:46
categories: ['5.技能', '编程语言', 'Python']
tags: ['python', 'srcard', '技能', '编程语言', 'Python']
---
  
  
## Micromamba 安装配置

1. **下载后进入安装目录执行以下命令：**
**Windows**
```sh
.\micromamba.exe shell init -s powershell

# 或：-p 参数设置 micromamba 的环境目录，如果不设置，默认为 $HOME/micromamba，和 miniconda 类似
.\micromamba.exe shell init -s powershell -p C:\Your\Root\Prefix
```
**Linux** [^10]
```sh
cd ~

curl -Ls https://micro.mamba.pm/api/micromamba/linux-64/latest | tar -xvj bin/micromamba

eval "$(./bin/micromamba shell hook -s posix)"

./bin/micromamba shell init -s bash -p ~/micromamba  # this writes to your .bashrc file

source ~/.bashrc

micromamba config append channels conda-forge
```
**Fish** 
```sh
sudo apt-add-repository ppa:fish-shell/release-3
sudo apt update
sudo apt install fish

cd ~
./bin/micromamba shell init -s fish -p ~/micromamba  
```

2. **安装 poetry**
micromamba 的 poetry 需要安装在虚拟环境里, `pip install poetry` 安装后执行 `poetry install` 配置 PythonPath

3. **设置国内镜像**:[^8]
`vim ~/.condarc`[^9]
```sh
channels: 
  - defaults
show_channel_urls: true
default_channels:
  - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main
  - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/r
  - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/msys2
custom_channels:
  conda-forge: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud
  msys2: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud
  bioconda: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud
  menpo: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud
  pytorch: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud
  pytorch-lts: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud
  simpleitk: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud
  deepmodeling: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/
```
<!--SR:!2024-07-02,153,250-->

<mark style="background: #fefe00A6;">windows 环境下</mark> 如果micromamba报错 `libmamba Could not solve for environment specs`:
```sh
PS D:\Git\Learn\slideshare-downloader> micromamba create -p ./venv python=3.9
warning  libmamba No 'channels' specified
error    libmamba Could not solve for environment specs
    The following package could not be installed
    └─ python 3.9**  does not exist (perhaps a typo or a missing channel).
critical libmamba Could not solve for environment specs
```
需要在执行micromamba命令时指定channel
  
第一步先检查micromamba程序是否已加入系统环境变量, 如果没有加入, 加入后重试。
如果还是不行, 运行命令时添加 -c 选项即可
```sh
micromamba create -p ./venv python=3.9 -c conda-forge
```
<!--SR:!2025-04-19,310,250-->

使用 conda 创建 3.9 python 环境:
  
```
# 创建时指定 venv 目录
condacp $ micromamba create -p ./venv python=2.7 

# 创建并导入 env 配置
condacf $ micromamba env create -f environment.yaml
condacfp $ micromamba env create -f environment.yaml -p ./venv

# 导出 env 配置
condaep $ micromamba env export -p ./venv | grep -v "^prefix:" > environment.yaml

# 安装lib
conda install requests
# 卸载lib
conda uninstall requests

# 更新package
conda env update --file environment.yaml --prune
# Attention: if there is a `name` tag with a name other than that of your environment in `local.yml`, the command above will create a new environment with that name. To avoid this, use
condaun $ conda env update -n py3.9 --file environment.yaml --prune
condaup $ conda env update -p ./venv --file environment.yaml --prune
```
<!--SR:!2025-07-18,450,250-->

如果 `conda init powershell` 失败, 新建 profile.ps1
放入`$PSHOME` 即 `C:\Windows\System32\WindowsPowerShell\v1.0` 目录[^3]
```
#region conda initialize
# !! Contents within this block are managed by 'conda init' !!
(& "D:\Program\miniconda3\Scripts\conda.exe" "shell.powershell" "hook") | Out-String | Invoke-Expression
#endregion
```

**配置 conda 源**

配置文件路径用户目录下: `~\.condarc`
```yaml
ssl_verify: false
always_yes: true
channels:
  - defaults
show_channel_urls: true
default_channels:
  - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main
  - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/r
  - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/msys2
custom_channels:
  conda-forge: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud
  msys2: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud
  bioconda: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud
  menpo: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud
  pytorch: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud
  pytorch-lts: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud
  simpleitk: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud
```
  
  
## Poetry 安装配置

<mark style="background: #83d98fA6;">Poetry 下载太慢了, 只适合当个启动器</mark> 

[Python 项目管理最佳实践 Poetry](../acc2d6da5dd37affe3f03e94d2997ae7cd02bc92)

环境变量：
```sh
C:\Users\qiaog\AppData\Roaming\Python\Scripts
# 或
C:\Users\qiaog\AppData\Roaming\pypoetry\venv\Scripts
```

配置 venv 为项目文件夹:
```sh
poetry config virtualenvs.create true
poetry config virtualenvs.in-project true
```

```sh
# 查看 poetry env
poetry config --list

# 使用 conda env
conda run --name py3.9 poetry run test.py
```

安装错误参考: [[Poetry add 报错 xxx not found in known hashes]]
  
  
## 引用

- [Essi Alizadeh - A Guide to Python Environment, Dependency and Package Management: Conda + Poetry](https://ealizadeh.com/blog/guide-to-python-env-pkg-dependency-using-conda-poetry/)
- [一篇文章带你上手Poetry、Conda与Pdm，轻松搭建Python虚拟多版本复杂开发环境 - 知乎](https://zhuanlan.zhihu.com/p/554965293)
- [Python开发篇——构建虚拟Python开发环境（Conda+Poetry）_Python_DisonTangor_InfoQ写作社区](https://xie.infoq.cn/article/59811f15c0cced35582839a40)
[^2]: [Conda update fails with SSL error CERTIFICATE_VERIFY_FAILED - Stack Overflow](https://stackoverflow.com/questions/33699577/conda-update-fails-with-ssl-error-certificate-verify-failed)
- [python - Any conda or pip operation give SSL Error in windows 10 - Stack Overflow](https://stackoverflow.com/questions/55185945/any-conda-or-pip-operation-give-ssl-error-in-windows-10)
- [Conda SSL Error: OpenSSL appears to be unavailable on this machine. OpenSSL is required to download and install packages. · Issue #11982 · conda/conda · GitHub](https://github.com/conda/conda/issues/11982)
- [Site Unreachable](https://stackoverflow.com/questions/42352841/how-to-update-an-existing-conda-environment-with-a-yml-file)
[^3]: [Site Unreachable](https://blog.csdn.net/aaadddmdsf/article/details/127912784)
[^4]: [Fetching Title#ta9t](https://www.anaconda.com/blog/a-faster-conda-for-a-growing-community)
[^5]: [Site Unreachable](https://community.anaconda.cloud/t/condavalueerror-key-solver-is-not-a-known-primitive-parameter/55287)
[^6]: [Fetching Title#i7le](https://aws-pytorch-doc.com/setup/)
[^7]: [使用 Micromamba 替换 Miniconda 更快配置 Python 环境 - 知乎](https://zhuanlan.zhihu.com/p/622346839)
[^8]: [ubunt下micromamba的安装 - 掘金](https://juejin.cn/post/7287805931382456332)
[^9]: https://blog.csdn.net/DMLong_x/article/details/127511433
[^10]: [Micromamba Installation — documentation](https://mamba.readthedocs.io/en/latest/micromamba-installation.html)

**相关笔记:**

- [Python 项目管理最佳实践 Poetry](../acc2d6da5dd37affe3f03e94d2997ae7cd02bc92)
- [Pytorch + Obsidian + Conda + Cuda 搭建交互式笔记开发环境](../b8bc8d6b00b5f8aacbc31724c33dd6ecb004e746)

{% pullquote mindmap mindmap-md %}
- 🔵
  - [Python 项目管理最佳实践 Poetry](../acc2d6da5dd37affe3f03e94d2997ae7cd02bc92)
  - [Pytorch + Obsidian + Conda + Cuda 搭建交互式笔记开发环境](../b8bc8d6b00b5f8aacbc31724c33dd6ecb004e746)
{% endpullquote %}