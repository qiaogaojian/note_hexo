---
title: Android Gradle 自定义插件
date: 2022-11-29 19:06:08
categories: ['5.技能', 'Android']
tags: ['gradle', 'srcard', 'android']
---

Android studio 通过 Gradle 来构建我们的项目。一般情况下，我们只是使用 Gradle 来配置一些功能，比如，**buildTypes**，**productFlavors** 等等。  

实际上，Gradle 提供了很多有用的功能，可以让我们更加方便的管理我们的项目。

这篇，我们介绍下 Gradle 的 Plugin 插件。  [官方介绍](https://docs.gradle.org/current/userguide/custom_plugins.html#sec:packaging_a_plugin)

Gradle 的 plugin 插件，有三种方式：
  
*   **Build script**  
可以直接在构建脚本(build.gradle)中包含插件的源代码。这样做的好处是插件可以自动编译并包含在构建脚本的类路径中，而不需要您做任何事情。然而，插件只能在定义它的构建脚本之内可见，不能在其他脚本中复用插件。
  
*   **buildSrc project**
创建一个 buildSrc 的项目，存放插件的代码
  
* **Standalone project**
创建一个单独的项目，生成并发布一个包含插件，任务等内容的 jar 包。
<!--SR:!2026-09-11,841,250-->

下面，我们就介绍下三种方式的插件分别怎么创建。
  
  
## 一. Build script

  
Build script 可以直接在构建脚本(build.gradle)中包含插件的源代码。
  
<mark style="background: #83d98fA6;">好处：</mark> 
- 直接在构建脚本(build.gradle)中包含插件的源代码。可以自动编译并包含在构建脚本的类路径中，无需执行其他操作。
  
<mark style="background: #fa518dA6;">坏处：</mark>  
- 插件只能在定义它的构建脚本(build.gradle)内可见，不能在其他构建脚本(build.gradle)中复用插件。
  
<mark style="background: #fbab4bA6;">一般来说，不会使用这种方式。</mark> 
  
**使用步骤:**
    
  
#### 1.1 新建插件脚本 hello.gradle  

![](/images/Pasted image 20221129153255.png)
    
  
#### 1.2 编写插件代码 

```groovy
class TestBuildScriptPlugin implements Plugin<Project> {  
    void apply(Project project) {  
        println("This is Build script gradle plugin.");  
  
        project.task('hello') {  
            doLast {  
                println 'Hello from the TestBuildScriptPlugin'  
            }  
        }    }  
}  
  
apply plugin: TestBuildScriptPlugin
```
一般来说，我们写的插件，都需要实现 Plugin 接口。在 apply() 方法中，写我们要实现的插件代码。
    
  
#### 1.3 导入app 构建脚本

![](/images/Pasted image 20221129152633.png)
    
  
#### 1.4 使用

打开命令行, 输入 `gradlew app:hello` 调用插件中定义的 `hello` task
```sh
$ gradlew app:hello
This is Build script gradle plugin.
> Task :app:hello
Hello from the TestBuildScriptPlugin
```
<!--SR:!2027-01-19,908,250-->
  
  
## 二. buildSrc project

这种方式，就是创建一个 buildSrc 的 module。  

因为，Gradle 插件支持 groovy,java,kotlin 语言，所以，根据我们使用的语言，可以把插件代码分别放到下面几个不同的目录下  
- `rootProjectDir/buildSrc/src/main/groovy  `
- `rootProjectDir/buildSrc/src/main/java`  
- `rootProjectDir/buildSrc/src/main/kotlin`

比如，我们想使用 java 语言来开发插件代码，我们就需要把我们的 java 代码放到 `rootProjectDir/buildSrc/src/main/java` 这个目录下。

<mark style="background: #83d98fA6;">好处：</mark> 
- 在其他构建脚本(build.gradle)中可见

<mark style="background: #fa518dA6;">坏处：</mark> 
- 只有当前的工程才能使用，其他的工程是不能复用
  
  
#### 2.1 创建 buildSrc 的 module。

创建一个名字为 **buildSrc(名字必须是这个)** 的 Android module。

把里面的 build 文件夹，src 下面的 res 文件夹等等，全部删除。

目录结构如下

![](https://img-blog.csdnimg.cn/2019122519301292.png)
  
  
#### 2.2 通过 build.gradle 添加依赖

上面说了，我们可以使用 groovy,kotlin,java 等语言开发。一般来说，使用 Java 或 Kotlin 实现的插件是静态类型的，其性能将优于使用 Groovy 实现的相同插件。这里，我们就使用最熟悉的 Java 来开发。

给 buildSrc 的 module 的 build.gradle 中添加依赖 

```groovy
// use java library
apply plugin: 'java-library'

// groovy library
//apply plugin: 'groovy'

apply plugin: 'maven-publish'

dependencies{
    // gradle sdk
    compile gradleApi()
    // groovy sdk
    compile localGroovy()
}

repositories{
    google()
    mavenCentral()
}
```
  
  
#### 2.3 创建插件代码

创建插件，需要实现 Plugin 接口。

这里，我们打印一句话。毕竟，我们只是学习创建 Plugin 插件的。

```java
package com.liu.loadplugin;

import org.gradle.api.Plugin;
import org.gradle.api.Project;

public class UploadPlugin implements Plugin<Project> {

  @Override
  public void apply(Project project) {
    System.out.println("this is my first buildSrc plugin !");
  }
}
```
  
  
#### 2.4 创建 properties 文件，关联插件

我们创建好了插件，接下来，我们需要创建一个 properties 的文件，把插件的名字跟插件关联起来。

1. 创建目录及文件 main/META-INF/gradle-plugins / 插件名. properties 文件。

比如，我们现在的插件名字是 com.liu.loadplugin.properties。

如下图

![](https://img-blog.csdnimg.cn/20191225193041380.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2VjbGl1amlhbmJv,size_16,color_FFFFFF,t_70)

2，在 properties 文件添加代码，关联插件

```groovy
implementation-class=com.liu.loadplugin.UploadPlugin
```

这个就是关联插件类的全路径（点击是可以跳转到类里面的）。

到这里，我们整个的 buildSrc 类型的插件就开发完了。
  
  
#### 2.5 使用插件

在我们的 app 的 module 的 build.gradle 里面引用插件。

```groovy
apply plugin: 'com.liu.loadplugin'
```

这里的名字是跟我们的 properties 的名字对应的。

重新构建一次，会看到我们在插件里写的那句话，打印出来了。

![](https://img-blog.csdnimg.cn/20191225192951335.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2VjbGl1amlhbmJv,size_16,color_FFFFFF,t_70)

到这里，我们 buildSrc 方式开发插件就完成了，下面看下独立的插件开发方式。
  
  
## 三. Standalone project

独立的插件。跟 buildSrc 的创建方式类似。  

但是，它相比与上面的那种，有几个明显的<mark style="background: #83d98fA6;">优点：</mark> 

*   插件的 module 名字，可以随意
*   这种方式，就是将我们写的一些插件，任务等等打包到一起，生成 jar，通过 jar 包的方式使用。所以， **在其他的项目也是可以使用的** 。

下面，我们来创建一个独立的插件。
  
  
#### 3.1 创建一个插件的 module

跟上面的方式类似，我们创建一个叫 alone_plugin(名字随意) 的 Android module。然后，删除 build,res 等无用的文件。

结构如下。

![](https://img-blog.csdnimg.cn/20191225193119523.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2VjbGl1amlhbmJv,size_16,color_FFFFFF,t_70)
  
  
#### 3.2 添加依赖 (build.gradle)

因为，这种独立插件的方式，最后是通过生成 jar 包，来共其他工程使用。所以，这里跟上面的方式有点不同。  
先看下, build.gradle 文件

```groovy
apply plugin: 'java-library'
apply plugin: 'maven'

dependencies {
    compile gradleApi()
    compile localGroovy()
}
repositories {
    mavenCentral()

}

group = 'com.liu.alone.plugin'
version = '1.0.0'
archivesBaseName = 'java-plugin'

//upload
uploadArchives {
    repositories {
        mavenDeployer {
            repository(url: uri('../repo'))
        }
    }
}
```

这里比 buildSrc 的方式多了下面，这些配置
```groovy
group = 'com.liu.alone.plugin'
version = '1.0.0'
archivesBaseName = 'java-plugin'

//upload
uploadArchives {
    repositories {
        mavenDeployer {
            repository(url: uri('../repo'))
        }
    }
}
```

我们是通过 maven 的方式，把插件发布到本地的 repo 目录下。我们知道 maven 发布需要指定：groupId,artifactId,version 的。通过，这三个声明，就可以找到我们的插件。
  
  
#### 3.2 创建插件，跟 properties 文件

这两个步骤跟我们上面的 buildSrc 创建插件的方式一样。这里就不写了。

目录结构如下图

![](https://img-blog.csdnimg.cn/20191225193131891.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2VjbGl1amlhbmJv,size_16,color_FFFFFF,t_70)
  
  
#### 3.3 maven 发布插件

通过 Gradle 的 alone_plugin 下面的 uploadArchives 命令。  
把我们的插件，发布到当前工程的 repo 目录下。

![](https://img-blog.csdnimg.cn/2019122519314187.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2VjbGl1amlhbmJv,size_16,color_FFFFFF,t_70)

通过上面的命令，就会把插件发布到项目下的 repo 目录里面。

如下图

![](https://img-blog.csdnimg.cn/20191225193143798.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2VjbGl1amlhbmJv,size_16,color_FFFFFF,t_70)
  
  
#### 3.4 引入插件

在项目的 build.gradle 引入我们发布的插件

```groovy
buildscript {
    repositories {
        google()
        jcenter()
        maven{
            url uri('./repo/')
        }
    }
    dependencies {
        classpath 'com.android.tools.build:gradle:3.3.1'

        classpath 'com.liu.alone.plugin:java-plugin:1.0.0'
    }
}
```

通过添加 maven 仓库。在 dependenies 里面引用。就把我们的插件引入了。
  
  
#### 3.5 使用

在 app module 的 build.gradle 里面引用跟 buildSrc 的方式一样。

```groovy
apply plugin: 'com.liu.alone.plugin'
```

最后，重新构建一次。就会打印出，我们插件里写的 Log。

![](https://img-blog.csdnimg.cn/20191225193203562.png)

到这里，自定义 Gradle 插件的三种方式，就介绍完了。

独立的插件，我们这里只是说了，在打包的项目使用。那么，其他的项目应该怎么使用呢。
  
  
#### 3.6 其他项目引用插件及优化

  
  
##### 3.6.1 其他项目引入插件

独立的插件开发方式的最终目的是让其他的项目也可以使用。那么，别的项目，怎么来引用呢。

这里，我们让其他的项目通过 jar 包的方式来引用。

首先，在需要引入的项目，创建一个 libs 文件夹 (这个应该是可以随意起的)。

![](https://img-blog.csdnimg.cn/20191227210932107.png)

其次，修改项目的 build.grandle

```groovy
buildscript {
    repositories {
        google()
        jcenter()
        flatDir{dir 'libs'}
    }
    dependencies {
        classpath 'com.android.tools.build:gradle:3.3.1'

        classpath 'com.liu.alone.plugin:java-plugin:1.0.0'
    }
}
```

这里，我们需要把 libs 添加进仓库中，然后，依赖这个插件。就完成了在其他项目的使用。

我们再来想一下。这种方式，是需要我们手动把 jar 包拷贝到需要的项目中的。有什么问题呢？
*   1. 手动拷贝，没有那么自动化
*   2. 如果这个插件升级了或者修改了呢，我们每次都拷贝？

既然是多个项目用的话。那么，我们可不可以上传到本地仓库。然后，其他的项目也使用本地仓库，来解决上面的问题呢。
  
  
##### 3.6.2 优化，上传到本地仓库

这里关于本地仓库配置本地 Maven 库，就不说明了。有兴趣可以看下这个：[Android Studio： 通过 Artifactory 搭建本地仓库优化编译速度](https://blog.csdn.net/android_jianbo/article/details/103738151)

我们首先创建一个本地仓库。让其依赖一个组 (android_depend)。  
因为我们不只是有一个插件，还有 jcenter 等等，都可以放到本地仓库中。

![](https://img-blog.csdnimg.cn/20191227211913567.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2VjbGl1amlhbmJv,size_16,color_FFFFFF,t_70)  
然后，修改我们的独立插件 alone_plugin 的 build.gradle。使其发布到本地仓库的 android_plugin 中，而不再发布到项目的 repo 目录下。

```groovy
apply plugin: 'java-library'
apply plugin: 'maven'
dependencies {
    compile gradleApi()
    compile localGroovy()
    compile 'com.android.tools.build:gradle:3.3.1'
    implementation("com.squareup.okhttp3:okhttp:3.8.1")
}
repositories {
    mavenCentral()

}

//group = 'com.liu.alone.plugin'
//version = '1.0.0'
//archivesBaseName = 'java-plugin'
//
//upload
//uploadArchives {
//    repositories {
//        mavenDeployer {
//            repository(url: uri('../repo'))
//        }
//    }
//}

//upload to local maven

uploadArchives {
    repositories {
        mavenDeployer {
            repository(url: "http://localhost:8081/artifactory/android_plugin/") {
                authentication(userName: "admin", password: "admin")
            }
            pom.version = "1.0.0"
            pom.artifactId = "java-plugin"
            pom.groupId = "com.liu.alone.plugin"
        }
    }
}

```

这里，我们已经修改其发布的位置了。发布成功后，看下本地仓库。

![](https://img-blog.csdnimg.cn/20191227212310443.png)  
这里，我们看到已经发布上去了。

然后，我们修改要引用插件的项目下的 build.gradle

```groovy
// Top-level build file where you can add configuration options common to all sub-projects/modules.

buildscript {
    repositories {
//        google()
//        jcenter()
        maven{
            url 'http://localhost:8081/artifactory/android_depend/'
        }
//        flatDir{dir 'libs'}
    }
    dependencies {
        classpath 'com.android.tools.build:gradle:3.3.1'

        classpath 'com.liu.alone.plugin:java-plugin:1.0.0'
    }
}

allprojects {
    repositories {
//        google()
//        jcenter()
        maven{
            url 'http://localhost:8081/artifactory/android_depend/'
        }
    }
}

task clean(type: Delete) {
    delete rootProject.buildDir
}

```

> 疑惑：这里需要，先发布到本地仓库；然后，把本地仓库添加到组中，这样，组中才有插件的包。  
> 先把本地仓库添加到组中，在发布插件到本地仓库，这样组中是没有这个插件包的 (本地仓库有)。

这里，我们看到，我们已经不再使用 libs 目录了，而是换成了本地仓库。  
这样的话，如果，独立插件再发布修改或者升级的话，我们也不需要手动拷贝 jar 包了。直接修改版本就可以了。

到这里，Gradle 的插件开发，就全部介绍完了。

自定义插件非常实用，我们完全可以通过自定义插件来一键实现打包，加固，上传，钉钉通知等功能。

**参考:**

- [blog.csdn.net](https://blog.csdn.net/android_jianbo/article/details/103704459)
